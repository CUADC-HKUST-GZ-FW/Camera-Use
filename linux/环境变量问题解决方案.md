# 相机控制程序问题解决方案

## 解决的问题

### 1. 环境变量问题
**错误**: `TypeError: unsupported operand type(s) for +: 'NoneType' and 'str'`
**原因**: `MVCAM_COMMON_RUNENV`环境变量没有正确设置

### 2. 设备名称解码问题  
**错误**: `AttributeError: 'c_ubyte_Array_64' object has no attribute 'decode'`
**原因**: 设备名称字段返回的是c_ubyte数组，需要先转换为bytes才能解码

### 3. X11显示问题
**错误**: `*******XOpenDisplay Fail *******`
**原因**: 无GUI环境下OpenCV尝试创建显示窗口

## 解决步骤

### 0. 快速测试

运行快速测试脚本验证修复：
```bash
chmod +x quick_test.sh
./quick_test.sh
```

### 1. 检查当前环境

首先运行环境检查脚本:
```bash
cd linux
python3 test_env.py
```

这将显示:
- 系统架构信息
- 当前环境变量状态
- SDK安装检测
- 库文件验证

### 2. 自动设置环境变量

运行改进的启动脚本:
```bash
chmod +x start_camera.sh
./start_camera.sh
```

新的启动脚本会:
- 自动检测系统架构(aarch64/x86_64)
- 搜索常见SDK安装路径
- 验证关键库文件存在
- 自动设置所有必要的环境变量

### 3. 手动设置环境变量（如果自动设置失败）

如果自动设置失败，手动设置环境变量:

#### 对于Jetson Orin Nano (aarch64):
```bash
# 假设SDK安装在 /opt/MVS
export MVS_SDK_PATH="/opt/MVS"
export MVCAM_COMMON_RUNENV="/opt/MVS/lib"
export LD_LIBRARY_PATH="/opt/MVS/lib/aarch64:/opt/MVS/lib:$LD_LIBRARY_PATH"
export PYTHONPATH="/opt/MVS/Samples/aarch64/Python/MvImport:$PYTHONPATH"
```

#### 对于通用Linux (x86_64):
```bash
export MVS_SDK_PATH="/opt/MVS"
export MVCAM_COMMON_RUNENV="/opt/MVS/lib"
export LD_LIBRARY_PATH="/opt/MVS/lib/64:/opt/MVS/lib/32:/opt/MVS/lib:$LD_LIBRARY_PATH"
export PYTHONPATH="/opt/MVS/Samples/64/Python/MvImport:$PYTHONPATH"
```

### 4. 验证设置

运行以下命令验证环境变量:
```bash
echo "MVCAM_COMMON_RUNENV: $MVCAM_COMMON_RUNENV"
echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH"
echo "PYTHONPATH: $PYTHONPATH"
```

### 5. 测试库加载

运行简单的Python测试:
```python
import os
print("MVCAM_COMMON_RUNENV:", os.environ.get('MVCAM_COMMON_RUNENV'))

# 测试库文件
import platform
arch = platform.machine()
if arch == 'aarch64':
    lib_path = os.path.join(os.environ['MVCAM_COMMON_RUNENV'], "aarch64", "libMvCameraControl.so")
else:
    lib_path = os.path.join(os.environ['MVCAM_COMMON_RUNENV'], "64", "libMvCameraControl.so")

print("库文件路径:", lib_path)
print("库文件存在:", os.path.exists(lib_path))

# 测试模块导入
try:
    import MvCameraControl_class
    print("✓ MvCameraControl_class 导入成功")
except ImportError as e:
    print("✗ 导入失败:", e)
```

## 修复验证

### 成功的输出示例
如果修复成功，您应该看到类似以下的输出：
```
2025-09-18 14:38:02,269 - INFO - 环境变量已设置: MVCAM_COMMON_RUNENV=/opt/MVS/lib
2025-09-18 14:38:02,270 - INFO - 找到SDK路径: /opt/MVS/Samples/aarch64/Python/MvImport
2025-09-18 14:38:02,279 - INFO - 海康威视SDK导入成功
2025-09-18 14:38:02,288 - INFO - 成功加载校准参数：../calibration/20250910_232046/calibration_result.json
2025-09-18 14:38:02,420 - INFO - 发现 1 个设备:
2025-09-18 14:38:02,421 - INFO -   [0] USB设备: MV-CA050-10UM
```

### 失败的输出示例
如果仍有问题，您会看到错误：
```
AttributeError: 'c_ubyte_Array_64' object has no attribute 'decode'
```

## 常见问题

### 1. SDK未安装
确保下载并安装了对应架构的海康威视SDK:
- ARM64 (aarch64): 下载Linux ARM64版本
- x86_64: 下载Linux 64位版本

### 2. 路径错误
确认SDK安装路径，常见位置:
- `/opt/MVS`
- `/usr/local/MVS`
- `/home/user/MVS`

### 3. 权限问题
确保当前用户有读取SDK文件的权限:
```bash
sudo chown -R $USER:$USER /opt/MVS
```

### 4. 架构不匹配
确认下载的SDK版本与系统架构匹配:
```bash
uname -m  # 显示系统架构
file /opt/MVS/lib/*/libMvCameraControl.so  # 显示库文件架构
```

## 自动化设置

为了永久设置环境变量，可以将其添加到shell配置文件:

```bash
# 添加到 ~/.bashrc 或 ~/.profile
echo 'export MVS_SDK_PATH="/opt/MVS"' >> ~/.bashrc
echo 'export MVCAM_COMMON_RUNENV="/opt/MVS/lib"' >> ~/.bashrc
echo 'export LD_LIBRARY_PATH="/opt/MVS/lib/aarch64:/opt/MVS/lib:$LD_LIBRARY_PATH"' >> ~/.bashrc
echo 'export PYTHONPATH="/opt/MVS/Samples/aarch64/Python/MvImport:$PYTHONPATH"' >> ~/.bashrc

# 重新加载配置
source ~/.bashrc
```

## 联系支持

如果问题仍然存在，请提供以下信息:
1. `test_env.py`的完整输出
2. 系统架构: `uname -a`
3. SDK版本和安装路径
4. 完整的错误信息