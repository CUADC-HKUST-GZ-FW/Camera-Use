# 海康威视相机控制程序 - 使用指南

## 🚀 快速开始

### 1. 检查设备连接
```bash
# 检查USB设备
lsusb | grep -i hikvision

# 应该看到类似输出：
# Bus 001 Device 005: ID 2bdf:0002 Hikvision camera
```

### 2. 运行快速测试
```bash
# 给脚本执行权限
chmod +x quick_test.sh

# 运行快速测试（推荐使用sudo）
sudo ./quick_test.sh
```

### 3. 如果测试通过，运行完整程序
```bash
sudo python3 hikvision_camera_controller_linux.py --calibration ../calibration/20250910_232046/calibration_result.json
```

## 🔧 故障排除

### 常见问题及解决方案

#### 1. CALLORDER错误 (0x80000004)
**症状**: 程序报告"函数调用顺序错误"

**解决方案（按优先级）**:
1. **重新插拔USB设备**
   ```bash
   # 拔出USB线，等待5秒，重新插入
   # 然后重新运行程序
   ```

2. **系统重启**（最有效）
   ```bash
   sudo reboot
   ```

3. **检查进程冲突**
   ```bash
   # 终止可能冲突的进程
   sudo pkill -f camera
   sudo pkill -f mvs
   ```

#### 2. 权限问题
**症状**: "权限被拒绝"或无法访问设备

**解决方案**:
```bash
# 运行权限修复脚本
chmod +x fix_permissions.sh
sudo ./fix_permissions.sh

# 或者手动设置权限
sudo chmod 666 /dev/bus/usb/*/*
```

#### 3. SDK导入失败
**症状**: "No module named MvCameraControl_class"

**解决方案**:
```bash
# 检查环境变量
source ~/.bashrc

# 或手动设置
export MVCAM_COMMON_RUNENV=/opt/MVS/lib
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/MVS/lib/aarch64
export PYTHONPATH=$PYTHONPATH:/opt/MVS/Samples/aarch64/Python/MvImport
```

## 📋 可用脚本和工具

### 测试脚本
- `quick_test.sh` - 快速测试CALLORDER错误
- `test_env.py` - 环境变量测试
- `test_permissions.py` - 权限测试
- `verify_fix.sh` - 综合验证测试

### 修复脚本
- `fix_permissions.sh` - 修复USB权限
- `diagnose_camera.sh` - 全面诊断

### 使用方法
```bash
# 给所有脚本执行权限
chmod +x *.sh

# 运行相应脚本
sudo ./脚本名称.sh
```

## 📖 程序功能

### 命令行参数
```bash
python3 hikvision_camera_controller_linux.py [OPTIONS]

选项:
  --calibration PATH    校准文件路径
  --output-dir PATH     输出目录（默认: ./captures）
  --preview            启用预览（需要显示器）
  --list-devices       列出可用设备
  --help               显示帮助信息
```

### 主要功能
1. **相机发现和连接**
2. **参数设置**（曝光、增益、白平衡等）
3. **图像采集**
4. **视频录制**
5. **校准参数应用**
6. **图像去畸变**

## 🎯 成功运行的标志

程序正常工作时，您应该看到：
```
✅ 环境变量检查通过
✅ 相机SDK实例创建成功
✅ 发现 1 个设备
✅ 设备句柄创建成功
✅ 设备连接成功
✅ 校准参数加载成功
相机控制程序已启动，按 'q' 退出...
```

## 🆘 如果所有方法都无效

1. **重新安装SDK**
   ```bash
   sudo rm -rf /opt/MVS
   # 下载最新的aarch64版本SDK重新安装
   ```

2. **检查硬件**
   - 尝试不同的USB端口
   - 使用不同的USB线
   - 在其他设备上测试相机

3. **联系技术支持**
   - 收集错误日志：
     ```bash
     sudo python3 hikvision_camera_controller_linux.py --calibration ../calibration/20250910_232046/calibration_result.json 2>&1 | tee error.log
     ```
   - 提供系统信息：
     ```bash
     uname -a > system_info.txt
     lsusb >> system_info.txt
     env | grep -E "(MVS|MVCAM|LD_LIBRARY|PYTHONPATH)" >> system_info.txt
     ```

## 📊 项目结构

```
linux/
├── hikvision_camera_controller_linux.py  # 主程序
├── test_env.py                          # 环境测试
├── test_permissions.py                  # 权限测试
├── fix_permissions.sh                   # 权限修复
├── diagnose_camera.sh                   # 问题诊断
├── quick_test.sh                        # 快速测试
├── verify_fix.sh                        # 验证修复
├── CALLORDER错误解决方案.md              # 详细故障排除
└── 使用指南.md                          # 本文件
```

记住：**大多数问题可以通过重新插拔USB设备或重启系统解决！**